AWSTemplateFormatVersion: '2010-09-09'
Description: Lambda-S3 Logging Project
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    PermissionsBoundary: arn:aws:iam::777957353822:policy/tricklercache-us-east-1-PermissionsBoundary
# Parameters:
#   AppId:
#     Type: String
Resources:
  dependencyLayer:
    Type: AWS::Serverless::LayerVersion
    Metadata:
      BuildMethod: nodejs18.x
      SamResourceId: dependencyLayer
    Properties:
      LayerName: dependencyLayer
      Description: Layer to Hold all Dependencies (reduce package size)
      ContentUri: s3://aws-us-east-1-777957353822-tricklercache-pipe/3c0fd418514675966096fdbbd27167fd
      CompatibleRuntimes:
      - nodejs18.x
  s3DropBucketFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: A Lambda function triggered on a file sent to an S3 bucket.
      Role: arn:aws:iam::777957353822:role/tricklercacheExecutionRole
      CodeUri: s3://aws-us-east-1-777957353822-tricklercache-pipe/8c9dbf85b43c564e8ae403c9efdff0ed
      Handler: s3-json-logger.s3DropBucketHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 508   #Cannot Set in the Interface as it falls back to 3 secs
      Timeout: 330       # 5 mins 30 seconds
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${BucketName}
      Layers:
      - Ref: dependencyLayer
    Metadata:
      Architecture: x86_64
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/s3DropBucket.ts
        External:
        - '@aws-sdk/client-s3'
        - node-fetch
        - nodejs
        - '@aws-sdk/fetch-http-handlerdeps/node-fetch'
        - '@aws-sdk/client3/package.json'
        Format: esm
        Minify: false
        OutExtension:
        - .js=.mjs
        Packages: external
        Platform: node
        Sourcemap: false
        Target: node18.12
      SamResourceId: s3DropBucketFunction
  S3DropBucketQueueProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: A Lambda function triggered on a file sent to an S3 bucket.
      Role: arn:aws:iam::777957353822:role/tricklercacheExecutionRole
      CodeUri: s3://aws-us-east-1-777957353822-tricklercache-pipe/8c9dbf85b43c564e8ae403c9efdff0ed
      Handler: s3DropBucket.S3DropBucketQueueProcessorHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128   #Set these in the Interface
      Timeout: 330       #Set these in the Interface //5 mins 30 seconds
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${BucketName}
      Layers:
      - Ref: dependencyLayer
    Metadata:
      Architecture: x86_64
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/s3DropBucket.ts
        External:
        - '@aws-sdk/client-s3'
        - node-fetch
        - nodejs
        - '@aws-sdk/fetch-http-handlerdeps/node-fetch'
        - '@aws-sdk/client3/package.json'
        Format: esm
        Minify: false
        OutExtension:
        - .js=.mjs
        Packages: external
        Platform: node
        Sourcemap: false
        Target: node18.12
      SamResourceId: s3DropBucketFunction
  s3DropBucketSFTPFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: A Lambda function triggered on a file sent to an S3 bucket.
      Role: arn:aws:iam::777957353822:role/tricklercacheExecutionRole
      CodeUri: s3://aws-us-east-1-777957353822-tricklercache-pipe/8c9dbf85b43c564e8ae403c9efdff0ed
      Handler: s3DropBucket.s3DropBucketSFTPHandler
      Runtime: nodejs18.x
      Architectures:
      - x86_64
      MemorySize: 128   #Set these in the Interface
      Timeout: 330       #Set these in the Interface //5 mins 30 seconds
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${BucketName}
      Layers:
      - Ref: dependencyLayer
    Metadata:
      Architecture: x86_64
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/s3DropBucket.ts
        External:
        - '@aws-sdk/client-s3'
        - node-fetch
        - nodejs
        - '@aws-sdk/fetch-http-handlerdeps/node-fetch'
        - '@aws-sdk/client3/package.json'
        Format: esm
        Minify: false
        OutExtension:
        - .js=.mjs
        Packages: external
        Platform: node
        Sourcemap: false
        Target: node18.12
      SamResourceId: s3DropBucketFunction
